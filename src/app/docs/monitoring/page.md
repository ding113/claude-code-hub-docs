---
dimensions:
  type:
    primary: operational
    detail: monitoring
  level: intermediate
standard_title: 监控与日志
language: zh
---

# 监控与日志

Claude Code Hub 提供全面的监控和日志功能，帮助管理员追踪使用情况、分析性能并确保系统健康运行。

---

## 日志查询

### 请求日志列表

访问 **Dashboard > Logs** 页面查看所有 API 请求的详细日志。

**日志列表显示的信息**：

| 字段 | 说明 |
|------|------|
| 时间 | 请求发生的时间戳 |
| Session ID | 会话标识符 |
| 用户 | 发起请求的用户名 |
| 密钥 | 使用的 API Key 名称 |
| 供应商 | 处理请求的供应商名称 |
| 模型 | 使用的模型名称 |
| 原始模型 | 重定向前的原始模型（如有） |
| Endpoint | API 端点路径 |
| 状态码 | HTTP 响应状态码 |
| Token 统计 | 输入/输出/缓存 Token 数量 |
| 费用 | 本次请求的计费金额 |
| 耗时 | 请求处理时长（毫秒） |
| 错误信息 | 如有错误则显示错误详情 |

**权限说明**：
- 管理员可查看所有用户的日志
- 普通用户只能查看自己的日志

### 高级筛选条件

日志页面支持多维度筛选，快速定位目标记录：

**时间范围筛选**
- 选择开始时间和结束时间
- 支持快捷选项：今日、昨日、本周、本月
- 时间基于系统配置的时区（默认 Asia/Shanghai）

**用户筛选**（仅管理员）
- 从下拉列表选择特定用户
- 支持搜索用户名

**密钥筛选**
- 选择特定的 API Key
- 管理员可筛选任意用户的 Key
- 普通用户只能筛选自己的 Key

**供应商筛选**
- 选择特定的供应商
- 用于分析各供应商的调用情况

**状态码筛选**
- 选择特定的 HTTP 状态码
- 常用选项：200（成功）、429（限流）、500（服务器错误）

**模型筛选**
- 选择特定的模型
- 列表显示所有曾被调用过的模型

**Endpoint 筛选**
- 选择特定的 API 端点
- 如 `/v1/messages`、`/v1/chat/completions` 等

### 日志详情查看

点击日志列表中的某条记录，可查看详细信息：

**基础信息**
- 完整的请求元数据
- 供应商链路（Provider Chain）：显示请求经过的所有供应商
- 供应商倍率：计费时使用的成本倍率

**Token 详情**
- 输入 Token 数量
- 输出 Token 数量
- 缓存创建 Token 数量
- 缓存读取 Token 数量
- 总 Token 数量

**客户端信息**
- User-Agent：客户端标识
- Messages 数量：请求中包含的消息数量

**拦截信息**（如适用）
- 拦截类型（如敏感词拦截）
- 拦截原因详情

### 导出功能

目前日志导出功能需要通过数据库直接查询实现。建议方式：

1. 使用数据库管理工具连接到 PostgreSQL
2. 查询 `message_request` 表获取日志数据
3. 导出为 CSV 或其他格式

```sql
-- 示例：导出今日日志
SELECT * FROM message_request
WHERE created_at >= CURRENT_DATE
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

---

## 使用排行榜

访问 **Dashboard > Leaderboard** 页面查看使用排行统计。

> **权限说明**：默认仅管理员可访问。可在系统设置中启用 `allowGlobalUsageView` 允许普通用户查看。

### 用户使用量排名

展示用户的消费排行，支持按日/月统计：

**今日排行**
- 按当日消费金额降序排列
- 显示请求次数、总消费、Token 总量

**本月排行**
- 按当月消费金额降序排列
- 便于月度成本分析

**排行榜字段**：

| 字段 | 说明 |
|------|------|
| 排名 | 按消费金额排序 |
| 用户名 | 用户显示名称 |
| 请求数 | 总请求次数 |
| 消费金额 | 总消费（美元） |
| Token 总量 | 所有类型 Token 之和 |

### 供应商调用排名

展示各供应商的使用情况：

| 字段 | 说明 |
|------|------|
| 供应商名称 | 供应商标识 |
| 请求数 | 处理的请求总数 |
| 消费金额 | 通过该供应商产生的费用 |
| Token 总量 | 处理的 Token 总数 |
| 成功率 | 成功请求占比 |
| 平均响应时间 | 请求处理平均耗时（毫秒） |

### 模型使用分布

展示各模型的调用统计：

| 字段 | 说明 |
|------|------|
| 模型名称 | 模型标识符 |
| 请求数 | 该模型的调用次数 |
| 消费金额 | 该模型产生的费用 |
| Token 总量 | 该模型消耗的 Token |
| 成功率 | 成功调用占比 |

> **说明**：当配置了模型重定向时，统计使用原始模型（用户请求的模型）而非实际转发的模型。

---

## 活跃 Session 监控

访问 **Dashboard > Sessions** 页面进行实时会话监控。

### 实时 Session 列表

页面自动刷新（默认 3 秒间隔），显示当前活跃的会话：

**活跃 Session 区域**
- 显示最近 5 分钟内有请求的会话
- 绿色高亮显示正在进行中的会话

**非活跃 Session 区域**
- 显示已超过 5 分钟无活动的会话
- 可能是已完成或暂停的会话

**列表字段**：

| 字段 | 说明 |
|------|------|
| Session ID | 会话唯一标识 |
| 用户 | 会话所属用户 |
| 密钥 | 使用的 API Key |
| 供应商 | 当前使用的供应商 |
| 模型 | 使用的模型 |
| API 类型 | chat 或 codex |
| 开始时间 | 会话首次请求时间 |
| Token 统计 | 累计 Token 使用量 |
| 费用 | 累计消费金额 |
| 请求数 | 会话内请求次数 |
| 持续时间 | 会话持续时长 |

### Session 详情

点击 Session ID 可查看详细信息：

**聚合统计**
- 总请求数
- 各类型 Token 统计
- 总消费金额
- 平均响应时间

**供应商链路**
- 会话中使用过的所有供应商
- 各供应商的使用模型列表

**Messages 内容**（需启用配置）
- 当 `STORE_SESSION_MESSAGES=true` 时可查看
- 显示会话中的完整对话内容
- 用于调试和审计

### 强制终止 Session

> **注意**：当前版本不支持从 UI 直接强制终止 Session。

如需终止长时间运行的 Session，可以：

1. **禁用相关 Key**：立即阻止该 Key 的后续请求
2. **调整限额**：降低并发 Session 限制使其自然终止
3. **等待超时**：Session 在无活动后会自动清理

---

## 供应商健康状态

访问 **Dashboard > Availability** 页面查看供应商健康监控。

> **权限说明**：仅管理员可访问此页面。

### 可用性指标

系统基于请求日志实时计算供应商可用性：

**状态指示**
- 🟢 **绿色**：可用性 >= 50%，运行正常
- 🔴 **红色**：可用性 < 50%，存在问题
- ⚪ **灰色/未知**：无请求数据，状态未知

**可用性计算**
```
可用性 = 成功请求数 / 总请求数
成功请求：HTTP 状态码 2xx 或 3xx
失败请求：HTTP 状态码 4xx、5xx 或无响应
```

### 响应时间监控

供应商详情展示响应时间指标：

| 指标 | 说明 |
|------|------|
| 平均响应时间 | 所有请求的平均耗时 |
| P50 延迟 | 50% 请求的响应时间阈值 |
| P95 延迟 | 95% 请求的响应时间阈值 |
| P99 延迟 | 99% 请求的响应时间阈值 |

### 错误率统计

**按时间段分析**
- 支持查看最近 1 小时、6 小时、24 小时、7 天的数据
- 时间桶自动调整（1分钟、5分钟、15分钟、1小时等）

**错误分布**
- 按状态码分类的错误统计
- 识别常见错误模式

### 时序图表

可用性页面提供时序可视化：

**数据点内容**
- 时间桶内的请求总数
- 成功/失败请求数
- 该时段的可用性得分
- 平均响应时间

**使用建议**
- 观察可用性波动趋势
- 识别问题发生的具体时间段
- 对比不同供应商的稳定性

---

## 仪表盘概览

Dashboard 首页提供快速概览：

### 活跃 Session 面板

页面顶部显示当前活跃的 Session 概览：
- 总活跃 Session 数
- 点击展开查看详细列表
- 快速链接到 Sessions 监控页

### 统计卡片

显示关键指标的汇总：
- 今日请求数
- 今日消费
- 今日 Token 使用量
- 当前活跃用户数

---

## 监控最佳实践

### 日常巡检建议

1. **每日检查**
   - 查看可用性页面，确认所有供应商状态正常
   - 检查排行榜，关注异常高消费用户
   - 查看错误日志，分析失败请求原因

2. **异常响应**
   - 发现供应商变红：检查供应商配置和上游状态
   - 发现高错误率：分析错误日志定位问题
   - 发现成本异常：检查是否有滥用行为

### 告警配置建议

当前版本未内置告警功能，建议：

1. **外部监控集成**
   - 使用 Prometheus + Grafana 监控数据库指标
   - 配置 AlertManager 发送告警通知

2. **日志聚合**
   - 将应用日志导出到 ELK 或类似系统
   - 配置关键错误的告警规则

### 数据保留建议

日志数据会随时间累积，建议配置定期清理：

1. 配置 `LOG_RETENTION_DAYS` 环境变量
2. 系统会自动清理超过保留期限的日志
3. 建议保留期限：30-90 天

### 性能优化建议

当日志量较大时：

1. **分页查询**：使用合理的分页大小（默认 50 条）
2. **缩小时间范围**：查询时指定较短的时间段
3. **使用筛选器**：通过筛选条件减少返回数据量
4. **定期归档**：将历史数据导出后清理

---

## 常见问题

### Q: 为什么看不到某些日志？

**可能原因**：
1. 权限限制：普通用户只能看到自己的日志
2. 时间范围：检查筛选的时间范围是否正确
3. 筛选条件：确认其他筛选条件是否过于严格

### Q: 供应商显示"未知"状态？

**原因**：最近 15 分钟内该供应商没有任何请求记录。

**解决方案**：
- 这是正常状态，表示没有足够数据判断可用性
- 可以手动发送测试请求验证供应商连通性

### Q: Session 监控数据不准确？

**可能原因**：
1. 缓存延迟：数据有短暂的缓存期
2. 网络问题：页面未能成功刷新
3. 时钟偏差：服务器与客户端时间不同步

**建议**：手动刷新页面或检查浏览器控制台是否有错误。

### Q: 排行榜数据与日志汇总不一致？

**原因**：排行榜使用聚合查询，可能与逐条统计存在微小差异。

**说明**：这是正常现象，通常差异在可接受范围内。
