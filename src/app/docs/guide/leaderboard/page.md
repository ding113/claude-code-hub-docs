---
dimensions:
  type:
    primary: getting-started
    detail: dashboard
  level: beginner
standard_title: 排行榜
language: zh
---

# 排行榜

排行榜页面提供按消费金额排序的用户和供应商使用统计，帮助团队管理员了解资源使用分布，支持费用分摊和用量治理。 {% .lead %}

---

## 页面概述

排行榜页面位于主导航的「排行榜」菜单项下，根据用户角色和系统配置展示不同的数据视图：

- **管理员**：可查看用户排行榜和供应商排行榜
- **普通用户**：仅在管理员开启「允许全站使用量查看」权限后可访问用户排行榜

{% callout title="权限说明" %}
普通用户默认无法访问排行榜页面。如需开放查看权限，管理员需在「系统设置」中启用「允许全站使用量查看」选项。
{% /callout %}

---

## 排行榜类型

### 用户排行榜

按消费金额从高到低展示所有用户的使用统计，包含以下指标：

| 列名 | 说明 |
|------|------|
| 排名 | 按消费金额排序的名次，前三名有特殊标识 |
| 用户 | 用户名称，前三名以加粗字体显示 |
| 请求数 | 该时间段内的总请求次数 |
| Token 数 | 消耗的总 Token 数量（包含输入、输出和缓存） |
| 消费金额 | 该时间段内的总消费金额 |

**排名标识：**

- 第 1 名：金色奖杯图标 + 金色徽章
- 第 2 名：银色奖牌图标 + 银色徽章
- 第 3 名：铜色奖章图标 + 铜色徽章
- 第 4 名及以后：仅显示排名数字

### 供应商排行榜

{% callout type="note" title="仅管理员可见" %}
供应商排行榜仅对管理员开放，普通用户即使开启了全站使用量查看权限也无法查看此榜单。
{% /callout %}

按消费金额从高到低展示所有供应商的使用统计，帮助管理员了解各供应商的负载和健康状况：

| 列名 | 说明 |
|------|------|
| 排名 | 按消费金额排序的名次 |
| 供应商 | 供应商名称 |
| 请求数 | 该时间段内处理的总请求次数 |
| 消费金额 | 该时间段内产生的总成本 |
| Token 数 | 消耗的总 Token 数量 |
| 成功率 | 请求成功的百分比（无错误消息的请求占比） |
| 平均响应时间 | 请求的平均处理时长（毫秒） |

---

## 时间范围筛选

排行榜支持两个时间维度的切换：

| 时间范围 | 说明 |
|----------|------|
| 今日 | 展示当天的统计数据，基于系统配置的时区计算 |
| 本月 | 展示当月的统计数据，从月初第一天开始计算 |

通过页面顶部的标签页可快速切换时间范围，数据会实时刷新。

{% callout type="note" title="时间计算方式" %}
**日历日模式（今日/本月）：**
- 「今日」基于系统配置的时区（`TZ` 环境变量），统计当天 00:00 到 23:59 的数据
- 「本月」统计当月第一天至今的数据

**滚动窗口模式（通知推送）：**
- 用于排行榜变动通知推送场景，采用滚动 24 小时窗口计算
- 从当前时间往回推 24 小时，不受时区日历日切换影响
- 此模式仅用于后台通知逻辑，不影响页面显示
{% /callout %}

---

## 界面操作

### 切换排行榜类型

1. 在页面顶部找到第一组标签页（用户排行榜 / 供应商排行榜）
2. 点击目标标签即可切换视图
3. 管理员可看到两个选项，普通用户只能看到「用户排行榜」

### 切换时间范围

1. 在页面顶部找到第二组标签页（今日 / 本月）
2. 点击目标时间范围，数据会自动刷新

### URL 参数支持

排行榜页面支持通过 URL 参数直接定位到特定视图：

```
/dashboard/leaderboard?scope=user&period=daily
/dashboard/leaderboard?scope=provider&period=monthly
```

| 参数 | 可选值 | 说明 |
|------|--------|------|
| `scope` | `user`, `provider` | 排行榜类型（供应商仅管理员可用） |
| `period` | `daily`, `monthly` | 时间范围 |

---

## 数据说明

### 数据来源

排行榜数据**完全基于请求日志（message_request 表）实时聚合计算**：

- 每次查看排行榜时，系统从日志表中按时间范围筛选并聚合统计
- 用户消费、Token 用量、供应商调用等数据均来自日志记录
- 不存在独立的统计快照或汇总表

{% callout type="warning" title="日志清理影响排行榜" %}
由于排行榜数据基于日志实时计算，**日志被清理后对应的统计数据也会丢失**。

- 如果清理了本月的日志，月排行榜将无法正确显示
- 建议**至少保留 30 天日志**，以确保月度排行榜正常工作
- 清理日志前，可在排行榜页面截图或导出数据作为记录
{% /callout %}

### Token 统计

Token 数量包含以下组成部分：

- **输入 Token**：请求中发送给模型的 Token 数
- **输出 Token**：模型生成的响应 Token 数
- **缓存创建 Token**：创建提示缓存时消耗的 Token
- **缓存读取 Token**：从缓存中读取的 Token

### 成本计算

消费金额基于以下因素计算：

- 模型定价（可在「价格表管理」中配置）
- 实际消耗的 Token 数量
- 供应商设置的成本系数（cost multiplier）

### 数据缓存

排行榜数据采用 Redis 乐观缓存策略，缓存 TTL 为 60 秒。这意味着：

- 数据最多延迟 60 秒更新
- 高并发访问时可快速响应
- Redis 不可用时会实时查询数据库

---

## 使用场景

### 费用分摊

对于多人共享的团队部署，排行榜可帮助管理员：

1. 了解各成员的 AI 工具使用量
2. 按月度消费进行费用分摊
3. 识别资源使用异常情况

### 用量治理

通过排行榜数据，管理员可以：

1. 监控整体资源消耗趋势
2. 识别高消耗用户并进行沟通
3. 调整用户配额限制（参考排行榜数据设置合理的限额）
4. 评估供应商性能和成本效益

### 供应商评估

供应商排行榜帮助管理员：

1. 比较各供应商的负载分布
2. 通过成功率识别问题供应商
3. 通过响应时间评估服务质量
4. 为供应商权重调整提供数据支持

---

## 权限配置

### 为普通用户开放排行榜

1. 登录管理后台
2. 进入「设置」→「系统配置」页面
3. 找到「允许全站使用量查看」选项
4. 启用该选项并保存

{% callout type="warning" title="隐私考虑" %}
开启此选项后，所有用户都可以看到其他用户的使用量排名。请根据团队隐私政策谨慎决定是否开放。
{% /callout %}

---

## 常见问题

### 排行榜显示"无数据"

**可能原因**：

1. 选择的时间范围内没有请求记录
2. 所有请求都失败未成功计费
3. 刚部署系统，尚未产生使用数据

**解决方案**：

- 切换到「本月」查看更长时间范围的数据
- 检查日志页面确认是否有成功的请求

### 无法访问排行榜页面

**可能原因**：

1. 当前用户非管理员且未开放全站查看权限

**解决方案**：

- 联系管理员开启「允许全站使用量查看」权限
- 或使用管理员账户登录查看

### 消费金额显示为 0

**可能原因**：

1. 价格表中没有对应模型的定价数据
2. 请求使用的模型未配置成本信息

**解决方案**：

- 进入「设置」→「价格表管理」同步最新价格数据
- 确认使用的模型在价格表中有对应条目

### 清理日志后排行榜数据消失了

**原因说明**：

排行榜的统计数据是基于请求日志（`message_request` 表）实时计算的，不存在独立的统计汇总表。当日志被清理后，用于计算的原始数据不存在了，排行榜自然也就无法显示这些数据。

**建议措施**：

1. **保留足够日志**：建议至少保留 30 天日志，以确保月排行榜正常工作
2. **清理前记录**：在清理日志前，可以截图保存当前排行榜数据
3. **使用自动清理**：配置自动清理保留 30 天以上的日志，避免误删当月数据

{% callout type="note" title="数据无法恢复" %}
日志清理是物理删除操作，数据无法恢复。如果已经清理了日志，对应时间段的统计数据将永久丢失。
{% /callout %}

---

## 下一步

- [请求日志](/docs/guide/logs) - 查看详细的请求记录
- [活跃 Session](/docs/guide/sessions) - 监控当前活跃会话
- [仪表盘](/docs/guide/dashboard) - 查看整体系统概览
