---
dimensions:
  type:
    primary: getting-started
    detail: configuration
  level: beginner
standard_title: 限额管理
language: zh
---

# 限额管理

Claude Code Hub 采用两级限额模型，让管理员能够灵活控制 API 使用量。本文档重点说明用户限额和密钥限额的关系与协同机制。 {% .lead %}

---

## 两级限额模型

CCH 的限额系统分为两个层级：

```
┌─────────────────────────────────────────┐
│            用户限额（上限）               │
│  ┌───────────────────────────────────┐  │
│  │  RPM、每日消费、5h/周/月消费等     │  │
│  └───────────────────────────────────┘  │
│                   ↓                      │
│        密钥限额不能超过用户限额            │
│                   ↓                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │ Key 1   │  │ Key 2   │  │ Key 3   │  │
│  │ 限额配置 │  │ 限额配置 │  │ 限额配置 │  │
│  └─────────┘  └─────────┘  └─────────┘  │
└─────────────────────────────────────────┘
```

- **用户限额**：作为总体上限，控制该用户所有 API 活动的最大消耗
- **密钥限额**：对单个密钥进行精细化控制，每个密钥可以有独立的限额配置

---

## 用户限额

在「用户管理」页面创建或编辑用户时，可以配置以下限额：

| 限额类型 | 说明 | 默认值 |
|---------|------|-------|
| RPM | 每分钟请求数限制 | 60 |
| 每日消费 | 每日消费金额上限（美元） | $100 |
| 5 小时限额 | 5 小时滚动窗口内的消费上限 | 不限制 |
| 周限额 | 每周消费上限 | 不限制 |
| 月限额 | 每月消费上限 | 不限制 |
| 并发 Session | 同时活跃的会话数量上限 | 不限制 |

{% callout type="warning" title="用户级实际检查范围" %}
当前版本中，用户级别仅实际检查 **RPM** 和 **每日消费** 两项限额。其他限额字段（5 小时、周、月、并发 Session）主要用于设置密钥限额的上限约束，确保密钥限额不会超过用户限额。
{% /callout %}

{% callout type="note" title="留空表示不限制" %}
高级限额字段留空表示不设置该维度的限制。建议根据实际需求合理配置。
{% /callout %}

---

## 密钥限额

在「用户管理」页面为用户创建或编辑 API Key 时，可以配置以下限额：

| 限额类型 | 说明 |
|---------|------|
| 5 小时限额 | 5 小时滚动窗口内的消费上限 |
| 每日限额 | 每日消费上限 |
| 周限额 | 每周消费上限 |
| 月限额 | 每月消费上限 |
| 并发 Session | 同时活跃的会话数量上限 |

{% callout type="note" title="密钥没有 RPM 限制" %}
RPM（每分钟请求数）仅在用户级别配置和检查。所有属于同一用户的密钥共享用户的 RPM 限额。
{% /callout %}

### 每日限额重置模式

密钥的每日限额支持两种重置模式：

| 模式 | 说明 |
|-----|------|
| 固定时间重置 | 在指定时间点重置（如每天 00:00 或 18:00） |
| 滚动窗口 | 过去 24 小时的滑动窗口 |

{% callout title="使用场景" %}
- **固定时间重置**：适合按自然日统计的场景，可设置与工作时间匹配的重置点
- **滚动窗口**：适合需要持续平滑限制的场景，避免重置时刻的突发使用
{% /callout %}

---

## 优先级与协同关系

{% callout type="warning" title="核心规则" %}
**用户限额是上限，不是各密钥限额之和。**
{% /callout %}

### 关键规则

1. **密钥限额不能超过用户限额**
   - 创建或编辑密钥时，系统会自动验证
   - 如果设置的密钥限额超过用户限额，将无法保存

2. **两级独立检查**
   - 每次 API 请求先检查用户级限额
   - 再检查密钥级限额
   - **任一超限即拦截**

3. **密钥限额独立计算**
   - 每个密钥有独立的消耗计数
   - 不是所有密钥共享用户限额

### 检查顺序示意

```
API 请求
  → 用户 RPM 检查
  → 用户每日消费检查
  → 密钥金额限制检查（5h/daily/weekly/monthly）
  → 密钥并发 Session 检查
  → 放行

任一环节超限 → 拦截 429
```

### 常见问题

**Q: 用户限额 $100，创建两个密钥各设 $50，总共能用 $100 还是 $50？**

A: 每个密钥独立计算，所以两个密钥各能用 $50。但用户层面的每日消费会累计计算，当用户总消费达到 $100 时，即使单个密钥还有余额，也会被用户级限额拦截。

**Q: 密钥没设限额，用户限额会生效吗？**

A: 会。用户级限额始终生效，无论密钥是否配置限额。密钥不设限额只是意味着跳过密钥级检查，用户级检查仍然执行。

**Q: 一个密钥超限了，其他密钥还能用吗？**

A: 可以。只要其他密钥未超限，且用户级限额未耗尽，其他密钥仍可正常使用。

---

## 使用场景

### 场景一：为团队成员分配独立密钥

一个用户账户分配给开发团队，每个成员使用独立密钥：

- 用户每日限额：$200（总预算）
- 成员 A 密钥：$80
- 成员 B 密钥：$80
- 成员 C 密钥：$80

每个成员的日消耗被限制在 $80 以内，同时用户总消耗不超过 $200。

### 场景二：区分开发和生产密钥

同一用户创建多个密钥用于不同环境：

- 用户每日限额：$500
- 生产环境密钥：$400（主力使用）
- 开发环境密钥：$50（测试用途）
- 调试密钥：$10（临时调试）

### 场景三：对外服务密钥限制

为外部合作方创建受限密钥：

- 用户每日限额：$100
- 合作方密钥：$20（严格限制）
- 重置模式：滚动窗口（避免重置时刻突发）

---

## 限额超限响应

当限额超限时，API 返回 HTTP 429 错误：

```json
{
  "error": {
    "type": "rate_limit_error",
    "message": "用户每日消费上限已达到（$105.20/$100）",
    "code": "rate_limit_exceeded",
    "limit_type": "daily_quota",
    "current": 105.20,
    "limit": 100,
    "reset_time": "2024-01-02T00:00:00.000Z"
  }
}
```

响应头包含限额信息：

| 响应头 | 说明 |
|-------|------|
| `X-RateLimit-Limit` | 限额值 |
| `X-RateLimit-Remaining` | 剩余额度 |
| `X-RateLimit-Reset` | 重置时间（Unix 时间戳，秒） |
| `X-RateLimit-Type` | 限流类型（rpm/daily_quota/usd_5h 等） |
| `Retry-After` | 建议重试等待秒数 |

---

## 相关页面

- [用户管理](/docs/guide/users) - 创建用户和配置限额
- [用户配额](/docs/guide/quotas-users) - 查看用户限额使用情况
- [供应商配额](/docs/guide/quotas-providers) - 查看供应商限额使用情况
- [限流监控](/docs/guide/rate-limits) - 查看限流触发记录
