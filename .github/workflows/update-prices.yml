name: Update Model Prices

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get current version
        id: current-version
        run: |
          if [ -f "public/config/prices-base.toml" ]; then
            VERSION=$(grep -A1 '^\[metadata\]' public/config/prices-base.toml | grep 'version' | cut -d'"' -f2)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Run price update script
        run: bun run update:prices

      - name: Get new version
        id: new-version
        run: |
          VERSION=$(grep -A1 '^\[metadata\]' public/config/prices-base.toml | grep 'version' | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet public/config/prices-base.toml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "message=No price updates" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "message=Price data updated from ${{ steps.current-version.outputs.version }} to ${{ steps.new-version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/config/prices-base.toml
          git commit -m "feat: update model prices

          ${{ steps.check.outputs.message }}

          ðŸ¤– Generated by scripts/convert-litellm-to-toml.ts"
          git push
