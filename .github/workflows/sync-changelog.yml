name: Sync CHANGELOG from upstream

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Fetch upstream CHANGELOG
        run: |
          curl -sSL https://raw.githubusercontent.com/ding113/claude-code-hub/main/CHANGELOG.md -o /tmp/upstream-changelog.md

      - name: Sync changelog content
        run: |
          LOCAL_FILE="src/app/docs/changelog/page.md"
          UPSTREAM_FILE="/tmp/upstream-changelog.md"

          # å®šä¹‰æœ¬åœ°å¤´éƒ¨ï¼ˆä¿æŒä¸å˜ï¼‰
          cat > /tmp/local-header.md << 'HEADER_EOF'
          ---
          dimensions:
            type:
              primary: reference
              detail: changelog
            level: beginner
          standard_title: æ›´æ–°æ—¥å¿—
          language: zh
          ---

          # æ›´æ–°æ—¥å¿—

          æœ¬é¡µé¢è®°å½• Claude Code Hub çš„æ‰€æœ‰ç‰ˆæœ¬å˜æ›´ï¼ŒæŒ‰æ—¶é—´å€’åºæŽ’åˆ—ã€‚ {% .lead %}

          ---

          HEADER_EOF

          # ä»Žä¸Šæ¸¸æå–æ­£æ–‡ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼Œä»Žç¬¬ä¸€ä¸ªç‰ˆæœ¬å¼€å§‹ï¼‰
          # ä¸Šæ¸¸æ ¼å¼ï¼š# Changelog / ## [vX.X.X]...
          awk '/^## \[v[0-9]+\.[0-9]+\.[0-9]+\]/{found=1} found{print}' "$UPSTREAM_FILE" > /tmp/upstream-body.md

          # åˆå¹¶å¤´éƒ¨å’Œä¸Šæ¸¸æ­£æ–‡
          cat /tmp/local-header.md /tmp/upstream-body.md > "$LOCAL_FILE"

          echo "Changelog synced successfully"

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet src/app/docs/changelog/page.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/app/docs/changelog/page.md
          git commit -m "docs: sync CHANGELOG from upstream

          ðŸ¤– Auto-synced from https://github.com/ding113/claude-code-hub/blob/main/CHANGELOG.md"
          git push
