# Webhook é€šçŸ¥ - æ¢ç´¢è‰ç¨¿ (Round 1)

## 1. æ¦‚è¿°

Claude Code Hub çš„ Webhook é€šçŸ¥ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤šå¹³å°ã€å¯æ‰©å±•çš„æ¶ˆæ¯æ¨é€è§£å†³æ–¹æ¡ˆï¼Œç”¨äºå‘å¤–éƒ¨ç³»ç»Ÿå‘é€å…³é”®äº‹ä»¶é€šçŸ¥ã€‚è¯¥ç³»ç»Ÿæ”¯æŒä¼ä¸šå¾®ä¿¡(WeChat Work)ã€é£ä¹¦(Feishu)ã€é’‰é’‰(DingTalk)ã€Telegram ä»¥åŠè‡ªå®šä¹‰ Webhook äº”ç§æ¨é€ç›®æ ‡ç±»å‹ï¼Œèƒ½å¤Ÿçµæ´»åœ°é€‚åº”ä¸åŒå›¢é˜Ÿçš„åä½œå·¥å…·ç”Ÿæ€ã€‚

Webhook é€šçŸ¥ç³»ç»Ÿçš„æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯ï¼š
- **å¹³å°æ— å…³æ€§**ï¼šé€šè¿‡ç»“æ„åŒ–æ¶ˆæ¯æŠ½è±¡å±‚ï¼Œç»Ÿä¸€å¤„ç†ä¸åŒå¹³å°çš„æ¶ˆæ¯æ ¼å¼å·®å¼‚
- **é«˜å¯é æ€§**ï¼šå†…ç½®æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶å’Œä»£ç†é™çº§ç­–ç•¥ï¼Œç¡®ä¿æ¶ˆæ¯é€è¾¾
- **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šç›®æ ‡ç®¡ç†ã€é€šçŸ¥ç±»å‹ç»‘å®šã€æ¨¡æ¿è¦†ç›–ç­‰é«˜çº§åŠŸèƒ½
- **æ˜“äºæ‰©å±•**ï¼šæ¨¡å—åŒ–çš„æ¸²æŸ“å™¨æ¶æ„ï¼Œä¾¿äºæ·»åŠ æ–°çš„æ¨é€å¹³å°æ”¯æŒ

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 åŒæ¨¡å¼æ¶æ„

Webhook é€šçŸ¥ç³»ç»Ÿæ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œä»¥å…¼é¡¾å‘åå…¼å®¹å’Œæ–°åŠŸèƒ½éœ€æ±‚ï¼š

#### Legacy æ¨¡å¼ï¼ˆæ—§ç‰ˆå• URL æ¨¡å¼ï¼‰

- æ¯ä¸ªé€šçŸ¥ç±»å‹é…ç½®ä¸€ä¸ª Webhook URL
- ç³»ç»Ÿè‡ªåŠ¨ä» URL æ£€æµ‹å¹³å°ç±»å‹ï¼ˆä¼ä¸šå¾®ä¿¡/é£ä¹¦ï¼‰
- é€‚ç”¨äºç®€å•åœºæ™¯ï¼Œé…ç½®å¿«é€Ÿ

#### æ–°æ¨¡å¼ï¼ˆå¤šç›®æ ‡ç®¡ç†æ¨¡å¼ï¼‰

- ç‹¬ç«‹çš„ Webhook Target ç®¡ç†ï¼Œæ”¯æŒå¤šå¹³å°é…ç½®
- é€šçŸ¥ç±»å‹ä¸ç›®æ ‡é€šè¿‡ç»‘å®šå…³ç³»å…³è”
- æ”¯æŒæ¨¡æ¿è¦†ç›–ã€æ—¶åŒºé…ç½®ã€ä»£ç†è®¾ç½®ç­‰é«˜çº§åŠŸèƒ½
- å½“åˆ›å»ºç¬¬ä¸€ä¸ª webhook_target æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ¨¡å¼

**è‡ªåŠ¨è¿ç§»æœºåˆ¶**ï¼š
```typescript
// å½“åˆ›å»ºç¬¬ä¸€ä¸ª webhook_target æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ¨¡å¼
const settings = await getNotificationSettings();
if (settings.useLegacyMode) {
  await updateNotificationSettings({ useLegacyMode: false });
}
```

### 2.2 æ ¸å¿ƒç»„ä»¶

Webhook ç³»ç»Ÿç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Webhook é€šçŸ¥ç³»ç»Ÿæ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  äº‹ä»¶è§¦å‘å™¨  â”‚â”€â”€â”€â–¶â”‚  æ¶ˆæ¯æ„å»ºå™¨  â”‚â”€â”€â”€â–¶â”‚   å¹³å°æ¸²æŸ“å™¨é˜Ÿåˆ—     â”‚ â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚                     â”‚ â”‚
â”‚  â”‚ â€¢ ç†”æ–­å‘Šè­¦  â”‚    â”‚ â€¢ ç»“æ„åŒ–æ¶ˆæ¯ â”‚    â”‚ â€¢ WeChat Renderer   â”‚ â”‚
â”‚  â”‚ â€¢ æˆæœ¬é¢„è­¦  â”‚    â”‚ â€¢ æ¨¡æ¿å˜é‡   â”‚    â”‚ â€¢ Feishu Renderer   â”‚ â”‚
â”‚  â”‚ â€¢ æ’è¡Œæ¦œ   â”‚    â”‚ â€¢ æ—¶åŒºå¤„ç†   â”‚    â”‚ â€¢ DingTalk Renderer â”‚ â”‚
â”‚  â”‚            â”‚    â”‚             â”‚    â”‚ â€¢ Telegram Renderer â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â€¢ Custom Renderer   â”‚ â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                   â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     WebhookNotifier                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚  URL æ„å»º   â”‚  â”‚  ç­¾åè®¡ç®—   â”‚  â”‚    HTTP å®¢æˆ·ç«¯       â”‚  â”‚â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ å¹³å°æ£€æµ‹  â”‚  â”‚ â€¢ é’‰é’‰ç­¾å  â”‚  â”‚ â€¢ ä»£ç†æ”¯æŒ          â”‚  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ ç«¯ç‚¹ç”Ÿæˆ  â”‚  â”‚ â€¢ å¯†é’¥ç®¡ç†  â”‚  â”‚ â€¢ é™çº§ç­–ç•¥          â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     é‡è¯•ä¸é”™è¯¯å¤„ç†                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ æŒ‡æ•°é€€é¿    â”‚  â”‚ å“åº”æ ¡éªŒ   â”‚  â”‚    æ—¥å¿—è®°å½•          â”‚  â”‚â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ baseDelay â”‚  â”‚ â€¢ å¹³å°ç‰¹å®š â”‚  â”‚ â€¢ å‘é€äº‹ä»¶          â”‚  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ maxRetriesâ”‚  â”‚ â€¢ é”™è¯¯æå– â”‚  â”‚ â€¢ å¤±è´¥è¿½è¸ª          â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

1. **äº‹ä»¶è§¦å‘**ï¼šç³»ç»Ÿæ£€æµ‹åˆ°éœ€è¦é€šçŸ¥çš„äº‹ä»¶ï¼ˆå¦‚ä¾›åº”å•†ç†”æ–­ã€æˆæœ¬è¶…é™ï¼‰
2. **æ¶ˆæ¯æ„å»º**ï¼šæ ¹æ®äº‹ä»¶ç±»å‹æ„å»ºç»“æ„åŒ–æ¶ˆæ¯ï¼ˆ`StructuredMessage`ï¼‰
3. **ç›®æ ‡è§£æ**ï¼šè·å–å¯ç”¨çš„ Webhook ç›®æ ‡åˆ—è¡¨å’Œç»‘å®šé…ç½®
4. **æ¶ˆæ¯æ¸²æŸ“**ï¼šæ ¹æ®ç›®æ ‡å¹³å°ç±»å‹ï¼Œä½¿ç”¨å¯¹åº”çš„æ¸²æŸ“å™¨ç”Ÿæˆå¹³å°ç‰¹å®šçš„ payload
5. **è¯·æ±‚å‘é€**ï¼šé€šè¿‡ HTTP POST å‘é€è¯·æ±‚ï¼Œæ”¯æŒä»£ç†å’Œç­¾å
6. **å“åº”å¤„ç†**ï¼šæ ¡éªŒå“åº”çŠ¶æ€ï¼Œå¤±è´¥æ—¶è§¦å‘é‡è¯•æœºåˆ¶

## 3. æ”¯æŒçš„å¹³å°ç±»å‹

### 3.1 ä¼ä¸šå¾®ä¿¡ (WeChat Work)

ä¼ä¸šå¾®ä¿¡é€šè¿‡å…¶ç¾¤æœºå™¨äºº Webhook æ¥å£æ¥æ”¶æ¶ˆæ¯ã€‚ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ« `qyapi.weixin.qq.com` åŸŸåçš„ URL ä½œä¸ºä¼ä¸šå¾®ä¿¡ç±»å‹ã€‚

**URL è‡ªåŠ¨æ£€æµ‹**ï¼šç³»ç»Ÿé€šè¿‡æ£€æµ‹ URL ä¸»æœºåè‡ªåŠ¨è¯†åˆ«å¹³å°ç±»å‹ï¼š
- `qyapi.weixin.qq.com` â†’ ä¼ä¸šå¾®ä¿¡
- `open.feishu.cn` â†’ é£ä¹¦
- å…¶ä»– URL â†’ éœ€è¦æ‰‹åŠ¨é€‰æ‹©å¹³å°ç±»å‹

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼å‘é€æ¶ˆæ¯
- æ”¯æŒæ–‡æœ¬ã€å¼•ç”¨ã€å­—æ®µåˆ—è¡¨ã€æœ‰åº/æ— åºåˆ—è¡¨ã€åˆ†éš”çº¿ç­‰å¤šç§å†…å®¹ç±»å‹
- è‡ªåŠ¨è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦

**é…ç½®è¦æ±‚**ï¼š
- ä»…éœ€ Webhook URLï¼ˆä»ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–ï¼‰

**æ¶ˆæ¯æ ¼å¼ç¤ºä¾‹**ï¼š
```json
{
  "msgtype": "markdown",
  "markdown": {
    "content": "### ä¾›åº”å•†ç†”æ–­å‘Šè­¦\n\n> ä¾›åº”å•† XXX å·²è§¦å‘ç†”æ–­ä¿æŠ¤\n\n**è¯¦ç»†ä¿¡æ¯**\nå¤±è´¥æ¬¡æ•°: 3 æ¬¡\né¢„è®¡æ¢å¤: 2024/01/15 14:30:00\n\n2024/01/15 14:00:00"
  }
}
```

### 3.2 é£ä¹¦ (Feishu/Lark)

é£ä¹¦é€šè¿‡å…¶è‡ªå®šä¹‰æœºå™¨äºº Webhook æ¥å£æ¥æ”¶æ¶ˆæ¯ï¼Œä½¿ç”¨äº¤äº’å¼å¡ç‰‡ï¼ˆInteractive Cardï¼‰æ ¼å¼ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨é£ä¹¦å¡ç‰‡ 2.0 æ ¼å¼
- æ”¯æŒæ ¹æ®æ¶ˆæ¯çº§åˆ«ï¼ˆinfo/warning/errorï¼‰æ˜¾ç¤ºä¸åŒé¢œè‰²çš„æ ‡é¢˜æ 
- å­—æ®µä»¥åŒåˆ—å¸ƒå±€å±•ç¤º
- è‡ªåŠ¨å¤„ç†æ—¶åŒºè½¬æ¢

**é…ç½®è¦æ±‚**ï¼š
- ä»…éœ€ Webhook URLï¼ˆä»é£ä¹¦ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–ï¼‰

**æ¶ˆæ¯æ ¼å¼ç¤ºä¾‹**ï¼š
```json
{
  "msg_type": "interactive",
  "card": {
    "schema": "2.0",
    "header": {
      "title": { "tag": "plain_text", "content": "ğŸ”Œ ä¾›åº”å•†ç†”æ–­å‘Šè­¦" },
      "template": "red"
    },
    "body": {
      "elements": [...]
    }
  }
}
```

### 3.3 é’‰é’‰ (DingTalk)

é’‰é’‰æ”¯æŒä¸¤ç§è®¤è¯æ–¹å¼ï¼šæ— ç­¾åå’ŒåŠ ç­¾æ¨¡å¼ã€‚ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨åŠ ç­¾ï¼Œéœ€è¦é…ç½®åŠ ç­¾å¯†é’¥ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼å‘é€æ¶ˆæ¯
- æ”¯æŒåŠ ç­¾å®‰å…¨æœºåˆ¶ï¼ˆHMAC-SHA256ï¼‰
- è‡ªåŠ¨è®¡ç®—æ—¶é—´æˆ³å’Œç­¾å

**é…ç½®è¦æ±‚**ï¼š
- Webhook URLï¼ˆä»é’‰é’‰ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–ï¼‰
- åŠ ç­¾å¯†é’¥ï¼ˆå¯é€‰ï¼Œå¦‚å¯ç”¨åŠ ç­¾å®‰å…¨è®¾ç½®åˆ™å¿…é¡»ï¼‰

**ç­¾åç®—æ³•**ï¼š
```typescript
const timestamp = Date.now();
const stringToSign = `${timestamp}\n${secret}`;
const sign = createHmac("sha256", secret).update(stringToSign).digest("base64");
// URL å‚æ•°: timestamp=${timestamp}&sign=${sign}
```

### 3.4 Telegram

Telegram é€šè¿‡ Bot API å‘é€æ¶ˆæ¯ï¼Œéœ€è¦é…ç½® Bot Token å’Œ Chat IDã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ HTML parse mode å‘é€æ¶ˆæ¯
- æ”¯æŒä¸°å¯Œçš„ HTML æ ‡ç­¾ï¼ˆ`<b>`, `<i>`, `<code>` ç­‰ï¼‰
- ç¦ç”¨ç½‘é¡µé¢„è§ˆä»¥ä¿æŒæ¶ˆæ¯ç®€æ´

**é…ç½®è¦æ±‚**ï¼š
- Bot Tokenï¼ˆä» @BotFather è·å–ï¼‰
- Chat IDï¼ˆç›®æ ‡èŠå¤©æˆ–ç¾¤ç»„çš„ IDï¼‰

**API ç«¯ç‚¹**ï¼š
```
POST https://api.telegram.org/bot${botToken}/sendMessage
```

### 3.5 è‡ªå®šä¹‰ Webhook (Custom)

è‡ªå®šä¹‰ Webhook å…è®¸ç”¨æˆ·å®šä¹‰è‡ªå·±çš„æ¶ˆæ¯æ ¼å¼å’Œè¯·æ±‚å¤´ï¼Œé€‚ç”¨äºé›†æˆåˆ°å†…éƒ¨ç³»ç»Ÿæˆ–ç¬¬ä¸‰æ–¹å¹³å°ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- æ”¯æŒ JSON æ¨¡æ¿å˜é‡æ›¿æ¢
- æ”¯æŒè‡ªå®šä¹‰ HTTP è¯·æ±‚å¤´
- æ”¯æŒæ¨¡æ¿è¦†ç›–ï¼ˆæŒ‰ç»‘å®šçº§åˆ«ï¼‰
- ä¸æ ¡éªŒå“åº”ä½“ç»“æ„ï¼ˆåªè¦ HTTP æˆåŠŸå³è§†ä¸ºæˆåŠŸï¼‰

**é…ç½®è¦æ±‚**ï¼š
- Webhook URL
- è‡ªå®šä¹‰æ¨¡æ¿ï¼ˆJSON å¯¹è±¡ï¼Œæ”¯æŒå˜é‡å ä½ç¬¦ï¼‰
- è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆå¯é€‰ï¼‰

**æ¨¡æ¿å˜é‡**ï¼š
- é€šç”¨å˜é‡ï¼š`{{timestamp}}`, `{{timestamp_local}}`, `{{title}}`, `{{level}}`, `{{sections}}`
- ç±»å‹ç‰¹å®šå˜é‡ï¼šå¦‚ç†”æ–­å‘Šè­¦çš„ `{{provider_name}}`, `{{failure_count}}` ç­‰

**æ¨¡æ¿ç¤ºä¾‹**ï¼š
```json
{
  "title": "{{title}}",
  "level": "{{level}}",
  "provider": "{{provider_name}}",
  "failure_count": "{{failure_count}}",
  "timestamp": "{{timestamp}}"
}
```

## 4. é€šçŸ¥äº‹ä»¶ç±»å‹

### 4.1 ç†”æ–­å™¨å‘Šè­¦ (Circuit Breaker)

å½“ä¾›åº”å•†ç«¯ç‚¹è¿ç»­å¤±è´¥è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘ç†”æ–­ï¼Œç³»ç»Ÿä¼šå‘é€ç†”æ–­å‘Šè­¦é€šçŸ¥ã€‚

**è§¦å‘æ¡ä»¶**ï¼š
- ä¾›åº”å•†ç«¯ç‚¹è¿ç»­å¤±è´¥æ¬¡æ•°è¾¾åˆ°ç†”æ–­é˜ˆå€¼ï¼ˆå¯åœ¨ä¾›åº”å•†é…ç½®ä¸­è‡ªå®šä¹‰ï¼Œé»˜è®¤ 5 æ¬¡ï¼‰
- ç†”æ–­å™¨ä»å¼€å¯çŠ¶æ€æ¢å¤æ—¶

**æ¶ˆæ¯å†…å®¹**ï¼š
- ä¾›åº”å•†åç§°å’Œ ID
- è¿ç»­å¤±è´¥æ¬¡æ•°
- é¢„è®¡æ¢å¤æ—¶é—´
- æœ€åä¸€æ¬¡é”™è¯¯ä¿¡æ¯

**æ•°æ®ç±»å‹å®šä¹‰**ï¼š
```typescript
interface CircuitBreakerAlertData {
  providerName: string;
  providerId: number;
  failureCount: number;
  retryAt: string;  // ISO 8601 æ ¼å¼
  lastError?: string;
}
```

**æ¶ˆæ¯çº§åˆ«**ï¼š`error`

### 4.2 æˆæœ¬é¢„è­¦ (Cost Alert)

å½“ç”¨æˆ·æˆ–ä¾›åº”å•†çš„æ¶ˆè´¹è¾¾åˆ°é…é¢é˜ˆå€¼æ—¶è§¦å‘é¢„è­¦é€šçŸ¥ã€‚

**è§¦å‘æ¡ä»¶**ï¼š
- 5å°æ—¶æ¶ˆè´¹è¾¾åˆ°é™é¢é˜ˆå€¼ï¼ˆæ£€æŸ¥ `limit5hUsd` é…ç½®ï¼‰
- å‘¨æ¶ˆè´¹è¾¾åˆ°é™é¢é˜ˆå€¼ï¼ˆæ£€æŸ¥ `limitWeeklyUsd` é…ç½®ï¼‰
- æœˆæ¶ˆè´¹è¾¾åˆ°é™é¢é˜ˆå€¼ï¼ˆæ£€æŸ¥ `limitMonthlyUsd` é…ç½®ï¼‰

**æ¶ˆæ¯å†…å®¹**ï¼š
- ç›®æ ‡ç±»å‹ï¼ˆç”¨æˆ·/ä¾›åº”å•†ï¼‰å’Œåç§°
- å½“å‰æ¶ˆè´¹é‡‘é¢
- é…é¢é™åˆ¶é‡‘é¢
- ä½¿ç”¨æ¯”ä¾‹ï¼ˆå¸¦é¢œè‰²æŒ‡ç¤ºå™¨ï¼‰
- å‰©ä½™é¢åº¦
- ç»Ÿè®¡å‘¨æœŸ

**æ•°æ®ç±»å‹å®šä¹‰**ï¼š
```typescript
interface CostAlertData {
  targetType: "user" | "provider";
  targetName: string;
  targetId: number;
  currentCost: number;
  quotaLimit: number;
  threshold: number;  // è§¦å‘é˜ˆå€¼ (0-1)
  period: string;     // å¦‚ "5å°æ—¶", "æœ¬å‘¨", "æœ¬æœˆ"
}
```

**æ¶ˆæ¯çº§åˆ«**ï¼š`warning`

**ä½¿ç”¨æ¯”ä¾‹æŒ‡ç¤ºå™¨**ï¼š
- ğŸ”´ çº¢è‰²ï¼šä½¿ç”¨æ¯”ä¾‹ >= 90%
- ğŸŸ¡ é»„è‰²ï¼šä½¿ç”¨æ¯”ä¾‹ >= 80%
- ğŸŸ¢ ç»¿è‰²ï¼šä½¿ç”¨æ¯”ä¾‹ < 80%

### 4.3 æ¯æ—¥æ¶ˆè´¹æ’è¡Œæ¦œ (Daily Leaderboard)

å®šæ—¶å‘é€è¿‡å» 24 å°æ—¶çš„ç”¨æˆ·æ¶ˆè´¹æ’è¡Œæ¦œã€‚

**è§¦å‘æ¡ä»¶**ï¼š
- æŒ‰é…ç½®çš„ Cron è¡¨è¾¾å¼å®šæ—¶è§¦å‘ï¼ˆé»˜è®¤æ¯å¤© 09:00ï¼‰

**æ¶ˆæ¯å†…å®¹**ï¼š
- ç»Ÿè®¡æ—¥æœŸ
- æ’ååˆ—è¡¨ï¼ˆæ˜¾ç¤ºå‰ N åï¼‰
- æ¯ä¸ªç”¨æˆ·çš„æ¶ˆè´¹é‡‘é¢ã€è¯·æ±‚æ¬¡æ•°ã€Token ä½¿ç”¨é‡
- æ€»è¯·æ±‚æ•°å’Œæ€»æ¶ˆè´¹é‡‘é¢

**æ•°æ®ç±»å‹å®šä¹‰**ï¼š
```typescript
interface DailyLeaderboardEntry {
  userId: number;
  userName: string;
  totalRequests: number;
  totalCost: number;
  totalTokens: number;
}

interface DailyLeaderboardData {
  date: string;
  entries: DailyLeaderboardEntry[];
  totalRequests: number;
  totalCost: number;
}
```

**æ¶ˆæ¯çº§åˆ«**ï¼š`info`

**Token æ ¼å¼åŒ–**ï¼š
- >= 1,000,000ï¼šæ˜¾ç¤ºä¸º `X.XXM`
- >= 1,000ï¼šæ˜¾ç¤ºä¸º `X.XXK`
- < 1,000ï¼šæ˜¾ç¤ºåŸå§‹æ•°å€¼

## 5. Webhook é…ç½®ç®¡ç†

### 5.1 æ•°æ®åº“æ¨¡å‹

#### Webhook Targets è¡¨

å­˜å‚¨æ¨é€ç›®æ ‡çš„åŸºæœ¬é…ç½®ï¼š

```typescript
{
  id: number;                    // ä¸»é”®
  name: string;                  // ç›®æ ‡åç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰
  providerType: ProviderType;    // å¹³å°ç±»å‹
  
  // é€šç”¨é…ç½®
  webhookUrl: string | null;     // Webhook URL
  
  // Telegram ç‰¹æœ‰
  telegramBotToken: string | null;
  telegramChatId: string | null;
  
  // é’‰é’‰ç‰¹æœ‰
  dingtalkSecret: string | null; // åŠ ç­¾å¯†é’¥
  
  // è‡ªå®šä¹‰ Webhook
  customTemplate: object | null; // JSON æ¨¡æ¿
  customHeaders: object | null;  // è‡ªå®šä¹‰è¯·æ±‚å¤´
  
  // ä»£ç†é…ç½®
  proxyUrl: string | null;
  proxyFallbackToDirect: boolean; // ä»£ç†å¤±è´¥æ—¶æ˜¯å¦å°è¯•ç›´è¿
  
  // çŠ¶æ€
  isEnabled: boolean;
  lastTestAt: Date | null;
  lastTestResult: object | null; // { success, error, latencyMs }
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### Notification Target Bindings è¡¨

å­˜å‚¨é€šçŸ¥ç±»å‹ä¸ç›®æ ‡çš„ç»‘å®šå…³ç³»ï¼š

```typescript
{
  id: number;
  notificationType: NotificationType;  // é€šçŸ¥ç±»å‹
  targetId: number;                    // å…³è”çš„ Webhook Target ID
  
  isEnabled: boolean;
  
  // å®šæ—¶é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºå®šæ—¶ç±»é€šçŸ¥ï¼‰
  scheduleCron: string | null;         // Cron è¡¨è¾¾å¼
  scheduleTimezone: string | null;     // æ—¶åŒº
  
  // æ¨¡æ¿è¦†ç›–ï¼ˆå¯é€‰ï¼Œä¸»è¦ç”¨äº custom webhookï¼‰
  templateOverride: object | null;
  
  createdAt: Date;
}
```

### 5.2 é…ç½®ç•Œé¢

ç³»ç»Ÿæä¾›å¯è§†åŒ–çš„ Webhook é…ç½®ç•Œé¢ï¼Œä½äºã€Œè®¾ç½® â†’ é€šçŸ¥è®¾ç½®ã€é¡µé¢ï¼š

#### æ¨é€ç›®æ ‡ç®¡ç†

- **ç›®æ ‡åˆ—è¡¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰é…ç½®çš„ Webhook ç›®æ ‡ï¼ŒåŒ…æ‹¬åç§°ã€ç±»å‹ã€æœ€åæµ‹è¯•çŠ¶æ€
- **åˆ›å»º/ç¼–è¾‘**ï¼šæ”¯æŒé…ç½®æ‰€æœ‰å¹³å°ç±»å‹çš„å‚æ•°
- **å¯ç”¨/ç¦ç”¨**ï¼šå¯å¿«é€Ÿåˆ‡æ¢ç›®æ ‡çš„å¯ç”¨çŠ¶æ€
- **æµ‹è¯•**ï¼šå‘ç›®æ ‡å‘é€æµ‹è¯•æ¶ˆæ¯ï¼ŒéªŒè¯è¿é€šæ€§
- **åˆ é™¤**ï¼šåˆ é™¤ç›®æ ‡ï¼ˆä¼šçº§è”åˆ é™¤å…³è”çš„ç»‘å®šï¼‰

#### é€šçŸ¥ç»‘å®šç®¡ç†

- **ç»‘å®šåˆ—è¡¨**ï¼šæ˜¾ç¤ºé€šçŸ¥ç±»å‹ä¸ç›®æ ‡çš„ç»‘å®šå…³ç³»
- **åˆ›å»ºç»‘å®š**ï¼šé€‰æ‹©é€šçŸ¥ç±»å‹å’Œç›®æ ‡ï¼Œé…ç½®å®šæ—¶å‚æ•°ï¼ˆå¦‚é€‚ç”¨ï¼‰
- **æ¨¡æ¿è¦†ç›–**ï¼šä¸º Custom ç±»å‹çš„ç›®æ ‡é…ç½®ç‰¹å®šçš„æ¨¡æ¿

### 5.3 æ—¶åŒºå¤„ç†

ç³»ç»Ÿæ”¯æŒå¤šçº§æ—¶åŒºé…ç½®ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

1. **Binding çº§åˆ«æ—¶åŒº** (`scheduleTimezone`) - åœ¨é€šçŸ¥ç»‘å®šä¸­é…ç½®
2. **ç³»ç»Ÿæ—¶åŒº** - é€šè¿‡ `resolveSystemTimezone()` ä»ç³»ç»Ÿè®¾ç½®è§£æ
3. **UTC** - é»˜è®¤å›é€€æ—¶åŒº

æ—¶åŒºç”¨äºï¼š
- å®šæ—¶é€šçŸ¥çš„è°ƒåº¦ï¼ˆå¦‚æ¯æ—¥æ’è¡Œæ¦œï¼‰
- æ¶ˆæ¯ä¸­çš„æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤º
- Cron è¡¨è¾¾å¼çš„è§£é‡Š

### 5.4 æ¨¡æ¿è¦†ç›–

å¯¹äº `custom` ç±»å‹çš„ Webhook ç›®æ ‡ï¼Œæ”¯æŒåœ¨ç»‘å®šçº§åˆ«é…ç½®æ¨¡æ¿è¦†ç›– (`templateOverride`)ï¼š

- ä»…å¯¹ `custom` å¹³å°ç±»å‹æœ‰æ•ˆ
- åœ¨ `notification_target_bindings` è¡¨çš„ `templateOverride` å­—æ®µé…ç½®
- è¦†ç›–ç›®æ ‡çº§åˆ«çš„é»˜è®¤æ¨¡æ¿
- æ”¯æŒç›¸åŒçš„æ¨¡æ¿å˜é‡

### 5.5 ä»£ç†é…ç½®

æ¯ä¸ª Webhook ç›®æ ‡å¯ä»¥ç‹¬ç«‹é…ç½®ä»£ç†ï¼š

- **ä»£ç† URL**ï¼šæ”¯æŒ HTTP/HTTPS/SOCKS ä»£ç†
- **é™çº§ç­–ç•¥**ï¼šé…ç½®ä»£ç†å¤±è´¥æ—¶æ˜¯å¦å°è¯•ç›´è¿ï¼ˆfallbackToDirectï¼‰

ä»£ç†é…ç½®åœ¨å‘é€æ—¶åŠ¨æ€ç”Ÿæ•ˆï¼š
```typescript
if (proxyConfig?.agent) {
  init.dispatcher = proxyConfig.agent;
}
```

## 6. é‡è¯•æœºåˆ¶

### 6.1 æŒ‡æ•°é€€é¿ç®—æ³•

Webhook é€šçŸ¥ç³»ç»Ÿå®ç°äº†æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿åœ¨ç½‘ç»œæŠ–åŠ¨æˆ–ç›®æ ‡æœåŠ¡æš‚æ—¶ä¸å¯ç”¨æ—¶èƒ½å¤Ÿè‡ªåŠ¨æ¢å¤ã€‚

**ç®—æ³•å®ç°**ï¼š
```typescript
const defaultBackoff = (attempt: number, baseDelay: number): number => {
  return baseDelay * 2 ** (attempt - 1);
};

// ç¤ºä¾‹å»¶è¿Ÿåºåˆ—ï¼ˆbaseDelay = 1000msï¼‰ï¼š
// ç¬¬ 1 æ¬¡é‡è¯•ï¼š1000ms
// ç¬¬ 2 æ¬¡é‡è¯•ï¼š2000ms
// ç¬¬ 3 æ¬¡é‡è¯•ï¼š4000ms
// ç¬¬ 4 æ¬¡é‡è¯•ï¼š8000ms
```

**é‡è¯•æµç¨‹**ï¼š
1. é¦–æ¬¡å‘é€å¤±è´¥
2. ç­‰å¾… `baseDelay * 2^(attempt-1)` æ¯«ç§’
3. å†æ¬¡å°è¯•å‘é€
4. è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åæ”¾å¼ƒï¼Œè®°å½•é”™è¯¯

### 6.2 é˜Ÿåˆ—çº§é‡è¯•

é€šçŸ¥é˜Ÿåˆ—ï¼ˆBull Queueï¼‰é…ç½®äº†ç‹¬ç«‹çš„é‡è¯•ç­–ç•¥ï¼š

```typescript
defaultJobOptions: {
  attempts: 3,           // ä»»åŠ¡çº§åˆ«é‡è¯• 3 æ¬¡
  backoff: {
    type: "exponential",
    delay: 60000,        // é¦–æ¬¡é‡è¯•å»¶è¿Ÿ 1 åˆ†é’Ÿ
  },
  removeOnComplete: 100, // ä¿ç•™æœ€è¿‘ 100 ä¸ªå®Œæˆä»»åŠ¡
  removeOnFail: 50,      // ä¿ç•™æœ€è¿‘ 50 ä¸ªå¤±è´¥ä»»åŠ¡
}
```

è¿™æ„å‘³ç€ï¼š
- Webhook å‘é€å™¨çº§åˆ«ï¼šæœ€å¤š 3 æ¬¡å°è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼Œ1s èµ·ï¼‰
- ä»»åŠ¡é˜Ÿåˆ—çº§åˆ«ï¼šæœ€å¤š 3 æ¬¡å°è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼Œ1min èµ·ï¼‰
- æ€»çš„æœ€å¤§å°è¯•æ¬¡æ•°ï¼š9 æ¬¡

### 6.3 é™çº§ç­–ç•¥

å½“é…ç½®äº†ä»£ç†æ—¶ï¼Œç³»ç»Ÿæ”¯æŒä»£ç†é™çº§ï¼š

```typescript
try {
  return await this.sendOnce(url, init);
} catch (error) {
  if (this.proxyConfig?.fallbackToDirect) {
    logger.warn("Webhook ä»£ç†å‘é€å¤±è´¥ï¼Œå°è¯•ç›´è¿é™çº§");
    return await this.sendOnce(url, {
      ...init,
      dispatcher: undefined,  // ç§»é™¤ä»£ç†
    });
  }
  throw error;
}
```

## 7. æ¶ˆæ¯æ¸²æŸ“æµç¨‹

### 7.1 ç»“æ„åŒ–æ¶ˆæ¯å®šä¹‰

æ‰€æœ‰æ¶ˆæ¯éƒ½åŸºäºç»Ÿä¸€çš„ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼ï¼š

```typescript
interface StructuredMessage {
  header: {
    title: string;
    icon?: string;
    level: "info" | "warning" | "error";
  };
  sections: Section[];
  footer?: Section[];
  timestamp: Date;
}

interface Section {
  title?: string;
  content: SectionContent[];
}

type SectionContent =
  | { type: "text"; value: string }
  | { type: "quote"; value: string }
  | { type: "fields"; items: { label: string; value: string }[] }
  | { type: "list"; style: "ordered" | "bullet"; items: ListItem[] }
  | { type: "divider" };
```

### 7.2 æ¸²æŸ“å™¨å®ç°

æ¯ä¸ªå¹³å°éƒ½æœ‰å¯¹åº”çš„æ¸²æŸ“å™¨ï¼Œå®ç° `Renderer` æ¥å£ï¼š

```typescript
interface Renderer {
  render(message: StructuredMessage, options?: WebhookSendOptions): WebhookPayload;
}
```

æ¸²æŸ“å™¨è´Ÿè´£ï¼š
1. å°†ç»“æ„åŒ–æ¶ˆæ¯è½¬æ¢ä¸ºå¹³å°ç‰¹å®šçš„æ ¼å¼
2. å¤„ç†æ—¶åŒºè½¬æ¢
3. è¿›è¡Œå¿…è¦çš„å­—ç¬¦è½¬ä¹‰
4. ç”Ÿæˆæœ€ç»ˆçš„è¯·æ±‚ä½“

### 7.3 å¹³å°ç‰¹å®šå¤„ç†

**ä¼ä¸šå¾®ä¿¡**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼
- è‡ªåŠ¨è½¬ä¹‰ HTML å­—ç¬¦

**é£ä¹¦**ï¼š
- ä½¿ç”¨äº¤äº’å¼å¡ç‰‡æ ¼å¼
- æ ¹æ®æ¶ˆæ¯çº§åˆ«è®¾ç½®æ ‡é¢˜é¢œè‰²
- å­—æ®µä»¥åŒåˆ—å¸ƒå±€å±•ç¤º

**é’‰é’‰**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼
- æ”¯æŒåŠ ç­¾å®‰å…¨æœºåˆ¶
- è‡ªåŠ¨è½¬ä¹‰ HTML å­—ç¬¦

**Telegram**ï¼š
- ä½¿ç”¨ HTML parse mode
- è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦ï¼ˆ`&`, `<`, `>`, `"`ï¼‰
- ç¦ç”¨ç½‘é¡µé¢„è§ˆ

**è‡ªå®šä¹‰**ï¼š
- æ”¯æŒæ¨¡æ¿å˜é‡æ›¿æ¢
- é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡å’Œæ•°ç»„
- æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´

## 8. æµ‹è¯•ä¸ç›‘æ§

### 8.1 è¿é€šæ€§æµ‹è¯•

ç³»ç»Ÿæä¾› Webhook è¿é€šæ€§æµ‹è¯•åŠŸèƒ½ï¼š

1. æ„å»ºæµ‹è¯•æ¶ˆæ¯ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
2. å‘é€å®é™…è¯·æ±‚åˆ°ç›®æ ‡ URL
3. è®°å½•å“åº”æ—¶é—´å’Œç»“æœ
4. æ›´æ–°ç›®æ ‡çš„ `lastTestAt` å’Œ `lastTestResult`

æµ‹è¯•æ¶ˆæ¯ä½¿ç”¨ä¸çœŸå®é€šçŸ¥ç›¸åŒçš„æ¸²æŸ“æµç¨‹ï¼Œç¡®ä¿æµ‹è¯•ç»“æœçš„å‡†ç¡®æ€§ã€‚

### 8.2 æ—¥å¿—è®°å½•

Webhook ç³»ç»Ÿè®°å½•äº†è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼š

**å‘é€æ—¥å¿—**ï¼š
```typescript
logger.info({
  action: "webhook_send",
  provider: this.providerType,
  bodyLength: payload.body.length,
});
```

**å¤±è´¥æ—¥å¿—**ï¼š
```typescript
logger.error({
  action: "webhook_send_failed",
  provider: this.providerType,
  error: errorMessage,
});
```

**é˜Ÿåˆ—äº‹ä»¶æ—¥å¿—**ï¼š
```typescript
logger.error({
  action: "notification_job_failed",
  jobId: job.id,
  type: job.data.type,
  error: err.message,
  attempts: job.attemptsMade,
});
```

### 8.3 æµ‹è¯•çŠ¶æ€å±•ç¤º

åœ¨ç®¡ç†ç•Œé¢ä¸­ï¼Œæ¯ä¸ª Webhook ç›®æ ‡æ˜¾ç¤ºï¼š
- æœ€åæµ‹è¯•æ—¶é—´
- æœ€åæµ‹è¯•ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- å“åº”å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰

## 9. å®‰å…¨è€ƒè™‘

### 9.1 ç­¾åéªŒè¯

é’‰é’‰ Webhook æ”¯æŒåŠ ç­¾å®‰å…¨æœºåˆ¶ï¼š
- ä½¿ç”¨ HMAC-SHA256 ç®—æ³•
- åŸºäºæ—¶é—´æˆ³å’Œå¯†é’¥ç”Ÿæˆç­¾å
- é˜²æ­¢è¯·æ±‚è¢«ç¯¡æ”¹æˆ–é‡æ”¾

### 9.2 æ•æ„Ÿä¿¡æ¯å¤„ç†

- Bot Tokenã€åŠ ç­¾å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯åœ¨æ•°æ®åº“ä¸­æ˜æ–‡å­˜å‚¨ï¼ˆè€ƒè™‘æœªæ¥åŠ å¯†ï¼‰
- æ—¥å¿—ä¸­ä¸è®°å½•æ•æ„Ÿä¿¡æ¯
- å‰ç«¯ç•Œé¢ä¸­æ•æ„Ÿå­—æ®µä½¿ç”¨å¯†ç è¾“å…¥æ¡†

### 9.3 æƒé™æ§åˆ¶

æ‰€æœ‰ Webhook ç®¡ç†æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼š
```typescript
if (!session || session.user.role !== "admin") {
  return { ok: false, error: "æ— æƒé™æ‰§è¡Œæ­¤æ“ä½œ" };
}
```

## 10. ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### 10.1 é…ç½®ä¼ä¸šå¾®ä¿¡å‘Šè­¦

1. åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤ä¸­æ·»åŠ æœºå™¨äººï¼Œè·å– Webhook URL
2. åœ¨ Claude Code Hub è®¾ç½®é¡µé¢åˆ›å»ºæ–°çš„ Webhook ç›®æ ‡
3. é€‰æ‹©ã€Œä¼ä¸šå¾®ä¿¡ã€ç±»å‹ï¼Œå¡«å…¥ Webhook URL
4. åˆ›å»ºé€šçŸ¥ç»‘å®šï¼Œé€‰æ‹©ã€Œç†”æ–­å™¨å‘Šè­¦ã€ç±»å‹
5. æµ‹è¯•è¿é€šæ€§ï¼Œç¡®ä¿æ¶ˆæ¯èƒ½æ­£å¸¸é€è¾¾

### 10.2 é…ç½®å¤šå¹³å°åŒæ—¶é€šçŸ¥

1. åˆ†åˆ«åˆ›å»ºä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ã€é’‰é’‰ä¸‰ä¸ª Webhook ç›®æ ‡
2. ä¸ºæ¯ä¸ªç›®æ ‡åˆ›å»ºã€Œæˆæœ¬é¢„è­¦ã€é€šçŸ¥ç»‘å®š
3. å½“æˆæœ¬é¢„è­¦è§¦å‘æ—¶ï¼Œä¸‰ä¸ªå¹³å°å°†åŒæ—¶æ”¶åˆ°é€šçŸ¥

### 10.3 é…ç½®è‡ªå®šä¹‰ Webhook é›†æˆå†…éƒ¨ç³»ç»Ÿ

1. åˆ›å»º Custom ç±»å‹çš„ Webhook ç›®æ ‡
2. é…ç½®è‡ªå®šä¹‰æ¨¡æ¿ï¼Œä½¿ç”¨å˜é‡å ä½ç¬¦
3. è®¾ç½®å†…éƒ¨ç³»ç»Ÿçš„æ¥æ”¶ URL
4. å†…éƒ¨ç³»ç»Ÿæ¥æ”¶åå¯æ ¹æ®æ¨¡æ¿å˜é‡è¿›è¡Œè‡ªå®šä¹‰å¤„ç†

## 11. å¾…å®Œå–„äº‹é¡¹

### 11.1 å·²çŸ¥é™åˆ¶

- ä¼ä¸šå¾®ä¿¡ï¼ˆ`qyapi.weixin.qq.com`ï¼‰å’Œé£ä¹¦ï¼ˆ`open.feishu.cn`ï¼‰çš„ URL è‡ªåŠ¨æ£€æµ‹ä¾èµ–äºç‰¹å®šåŸŸåï¼Œä¸æ”¯æŒè‡ªå®šä¹‰åŸŸåï¼›é’‰é’‰ä¸æ”¯æŒ URL è‡ªåŠ¨æ£€æµ‹ï¼Œå¿…é¡»æ‰‹åŠ¨é€‰æ‹©å¹³å°ç±»å‹
- è‡ªå®šä¹‰ Webhook çš„æ¨¡æ¿å˜é‡ç±»å‹æœ‰é™ï¼Œä¸æ”¯æŒå¤æ‚çš„æ¡ä»¶é€»è¾‘
- æ•æ„Ÿä¿¡æ¯ï¼ˆTokenã€å¯†é’¥ï¼‰ç›®å‰ä»¥æ˜æ–‡å­˜å‚¨

### 11.2 å¯èƒ½çš„æ”¹è¿›æ–¹å‘

- æ”¯æŒæ›´å¤šçš„æ¨é€å¹³å°ï¼ˆå¦‚ Slackã€Discordã€Microsoft Teamsï¼‰
- æ·»åŠ æ¶ˆæ¯å†å²è®°å½•å’ŒæŸ¥è¯¢åŠŸèƒ½
- æ”¯æŒæ›´å¤æ‚çš„æ¨¡æ¿å¼•æ“ï¼ˆå¦‚ Handlebarsï¼‰
- å®ç°æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- æ·»åŠ  Webhook ç­¾åéªŒè¯ï¼ˆæ¥æ”¶ç«¯ï¼‰

## 12. ç›¸å…³ä»£ç æ–‡ä»¶

### æ ¸å¿ƒå®ç°

- `src/lib/webhook/index.ts` - Webhook æ¨¡å—å…¥å£
- `src/lib/webhook/types.ts` - ç±»å‹å®šä¹‰
- `src/lib/webhook/notifier.ts` - WebhookNotifier å®ç°
- `src/lib/webhook/utils/retry.ts` - é‡è¯•æœºåˆ¶

### æ¸²æŸ“å™¨

- `src/lib/webhook/renderers/index.ts` - æ¸²æŸ“å™¨å·¥å‚
- `src/lib/webhook/renderers/wechat.ts` - ä¼ä¸šå¾®ä¿¡æ¸²æŸ“å™¨
- `src/lib/webhook/renderers/feishu.ts` - é£ä¹¦æ¸²æŸ“å™¨
- `src/lib/webhook/renderers/dingtalk.ts` - é’‰é’‰æ¸²æŸ“å™¨
- `src/lib/webhook/renderers/telegram.ts` - Telegram æ¸²æŸ“å™¨
- `src/lib/webhook/renderers/custom.ts` - è‡ªå®šä¹‰æ¸²æŸ“å™¨

### æ¶ˆæ¯æ¨¡æ¿

- `src/lib/webhook/templates/index.ts` - æ¨¡æ¿å…¥å£
- `src/lib/webhook/templates/circuit-breaker.ts` - ç†”æ–­å‘Šè­¦æ¶ˆæ¯
- `src/lib/webhook/templates/cost-alert.ts` - æˆæœ¬é¢„è­¦æ¶ˆæ¯
- `src/lib/webhook/templates/daily-leaderboard.ts` - æ’è¡Œæ¦œæ¶ˆæ¯
- `src/lib/webhook/templates/placeholders.ts` - æ¨¡æ¿å˜é‡å®šä¹‰
- `src/lib/webhook/templates/defaults.ts` - é»˜è®¤æ¨¡æ¿

### æ•°æ®å±‚

- `src/drizzle/schema.ts` - æ•°æ®åº“è¡¨å®šä¹‰
- `src/repository/webhook-targets.ts` - Webhook Target ä»“å‚¨
- `src/repository/notification-bindings.ts` - é€šçŸ¥ç»‘å®šä»“å‚¨
- `src/repository/notifications.ts` - é€šçŸ¥è®¾ç½®ä»“å‚¨

### ä¸šåŠ¡é€»è¾‘

- `src/actions/webhook-targets.ts` - Webhook ç›®æ ‡ç®¡ç† Actions
- `src/actions/notifications.ts` - é€šçŸ¥ç›¸å…³ Actions
- `src/actions/notification-bindings.ts` - é€šçŸ¥ç»‘å®š Actions
- `src/lib/notification/notification-queue.ts` - é€šçŸ¥é˜Ÿåˆ—
- `src/lib/constants/notification.constants.ts` - é€šçŸ¥ç±»å‹å¸¸é‡

### å·¥å…·å‡½æ•°

- `src/lib/webhook/utils/date.ts` - æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
- `src/lib/webhook/templates/test-messages.ts` - æµ‹è¯•æ¶ˆæ¯æ¨¡æ¿

### å‰ç«¯ç•Œé¢

- `src/app/[locale]/settings/notifications/` - é€šçŸ¥è®¾ç½®é¡µé¢
- `src/app/[locale]/settings/notifications/_components/webhook-targets-section.tsx` - ç›®æ ‡ç®¡ç†
- `src/app/[locale]/settings/notifications/_components/webhook-target-dialog.tsx` - åˆ›å»º/ç¼–è¾‘å¯¹è¯æ¡†
- `src/app/[locale]/settings/notifications/_components/webhook-type-form.tsx` - ç±»å‹ç‰¹å®šè¡¨å•
- `src/app/[locale]/settings/notifications/_components/webhook-target-card.tsx` - ç›®æ ‡å¡ç‰‡

### API è·¯ç”±

- `src/app/api/actions/[...route]/route.ts` - åŒ…å« Webhook ç›¸å…³çš„ API ç«¯ç‚¹

---

*æœ¬æ–‡æ¡£ä¸ºæ¢ç´¢è‰ç¨¿ï¼ŒåŸºäº Claude Code Hub é¡¹ç›®ä»£ç åˆ†æç”Ÿæˆã€‚å†…å®¹æ¶µç›– Webhook é€šçŸ¥ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€é…ç½®ç®¡ç†ã€äº‹ä»¶ç±»å‹ã€é‡è¯•æœºåˆ¶ç­‰æ–¹é¢ã€‚*
